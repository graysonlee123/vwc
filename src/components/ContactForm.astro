<form
  id="contact-form"
  action="https://formspree.io/f/mwppdgqq"
  method="POST"
>
  <label for="name">Name</label>
  <input
    type="text"
    name="name"
    id="name"
    required
  />
  <label for="email">Email</label>
  <input
    type="email"
    name="email"
    id="email"
    required
  />
  <label for="message">Message</label>
  <textarea
    name="message"
    id="message"
    required
  />
  <button type="submit">Send</button>
</form>

<script>
  import { PUBLIC_FORMSPREE_FORM_ID } from "astro:env/client"

  // TODO: Type this properly
  type FormspreeResponse = {
    errors: FormspreeError[]
  }

  type FormspreeError = {
      message: string
  }

  (() => {
    const form = document.querySelector<HTMLFormElement>('contact-form')

    if (!form) {
      console.error('Contact form not found.')
      return
    }

    form.addEventListener('submit', async (e) => {
      e.preventDefault()

      const formData = new FormData(form)

      try {
        const response = await fetch(
          `https://formspree.io/f/${PUBLIC_FORMSPREE_FORM_ID}`,
          {
            method: form.method,
            body: formData,
            headers: {
              Accept: 'application/json',
            },
          }
        )

        const data: FormspreeResponse = await response.json()
        console.log({ data })

        if (!response.ok) {
          if (Object.hasOwn(data, 'errors')) {
            alert(data["errors"].map(error => error["message"]).join(", "))
          }

          throw new Error('Oops! There was a problem submitting your form')
        } else {
          form.reset()
          // TODO: Handle success notications with something like toastify-js
          alert('Message sent!')
        }
      } catch (error) {
        // TODO: Handle error notications with something like toastify-js
        console.error(error)
      }
    })
  })()
</script>
